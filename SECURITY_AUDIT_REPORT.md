# セキュリティ監査レポート - 会社ベースアクセス制御

## 概要
このレポートは、プロジェクトメンバー選択時に他社のユーザーが見える重大なセキュリティ問題の修正について記録したものです。

## 発見された問題

### 1. 重大: ユーザーAPI（/users）での会社間情報漏洩
**問題**: `/users` APIエンドポイントで会社ベースのフィルタリングが実装されていないため、すべてのユーザーがすべての会社のユーザー情報を閲覧可能でした。

**影響**: COMPANY及びMANAGERロールユーザーが他社の従業員情報を取得可能

**修正**: 
- ADMINユーザー: すべてのユーザーにアクセス可能（オプションでcompanyIdフィルタ）
- COMPANYユーザー: 管理する会社（managedCompanyId）のユーザーのみ表示
- MANAGERユーザー: 自社（companyId）のユーザーのみ表示

### 2. 重大: Activities API（/activities/recent）での会社間情報漏洩
**問題**: 活動履歴APIで会社ベースのフィルタリングが不適切でした。

**修正**:
- ADMINユーザー: すべての活動を表示
- COMPANYユーザー: 管理する会社の活動のみ表示
- MANAGERユーザー: 自社の活動のみ表示
- MEMBERユーザー: 自分の活動のみ表示

### 3. 重大: Project Work Settings API権限不備
**問題**: プロジェクト勤務設定で権限チェックが不十分でした。

**修正**: プロジェクトメンバーシップと会社所属の両方をチェック

### 4. 重大: Repair API認証なし
**問題**: `/repair/*` エンドポイントが認証なしでアクセス可能でした。

**修正**: すべてのrepairエンドポイントにADMIN権限を追加

### 5. 重大: Subscriptions API権限不備
**問題**: 複数のサブスクリプションエンドポイントで会社ベースアクセス制御が不十分でした。

**修正**: 
- `/all` エンドポイント: ADMIN専用
- `/payments` エンドポイント: 会社所有権チェック追加
- `/overview` エンドポイント: ADMIN専用

### 6. Work Schedule API権限不備
**問題**: 勤務スケジュール詳細取得で会社ベースのアクセス制御が不足していました。

**修正**: 会社所属の確認を追加

## 修正されたファイル

### バックエンドAPIルート:
- `backend/src/routes/users.js` - ユーザーAPI会社フィルタリング
- `backend/src/routes/activities.js` - 活動履歴会社フィルタリング
- `backend/src/routes/projectWorkSettings.js` - プロジェクト勤務設定権限強化
- `backend/src/routes/repair.js` - 認証・認可追加
- `backend/src/routes/subscriptions.js` - サブスクリプションアクセス制御
- `backend/src/routes/workSchedule.js` - 勤務スケジュールアクセス制御

### フロントエンド:
- `frontend/src/components/AddMemberDialog.jsx` - デバッグログ削除
- `frontend/src/pages/Projects.jsx` - ステータス値修正
- `frontend/src/utils/validation.js` - バリデーションスキーマ更新

### その他:
- すべてのファイルからconsole.logステートメントを削除
- プロジェクトステータス値を`ACTIVE`から`IN_PROGRESS`に統一
- ロール名を`EMPLOYEE`から`MEMBER`に統一

## セキュリティレベル向上

### 実装されたアクセス制御ルール:

#### ADMIN ロール:
- すべてのデータに無制限アクセス
- 全会社の情報を管理可能

#### COMPANY ロール:
- 管理する会社（managedCompanyId）のデータのみアクセス可能
- 自社従業員、プロジェクト、活動の管理

#### MANAGER ロール:
- 所属会社（companyId）のデータのみアクセス可能
- 部下および自分が参加するプロジェクトの管理

#### MEMBER ロール:
- 自分の情報および参加プロジェクトのみアクセス可能
- 最小権限の原則に従った制限

## 検証方法

### 1. API エンドポイントテスト
各ロールでAPIを呼び出し、適切にフィルタリングされることを確認：

```javascript
// COMPANY ロールで他社ユーザーが見えないことを確認
GET /api/users (as COMPANY user)
// -> 自分が管理する会社のユーザーのみ返される

// MANAGER ロールで他社活動が見えないことを確認  
GET /api/activities/recent (as MANAGER user)
// -> 自社の活動のみ返される
```

### 2. プロジェクトメンバー選択テスト
プロジェクト作成・編集時にメンバー選択で他社ユーザーが表示されないことを確認

### 3. 権限昇格テスト
下位ロールから上位データへの不正アクセスができないことを確認

## 推奨される追加セキュリティ対策

### 1. ログ監査
- 異常なアクセスパターンの検出
- 権限エラーの監視とアラート

### 2. レート制限
- API呼び出し頻度の制限
- ブルートフォース攻撃対策

### 3. データ暗号化
- 機密情報のデータベース暗号化
- 転送時の暗号化強化

### 4. 定期セキュリティテスト
- 自動化されたセキュリティテストの実装
- 継続的な脆弱性評価

## 結論

このセキュリティ修正により、会社間のデータ分離が適切に実装され、ロールベースアクセス制御（RBAC）が強化されました。各ユーザーは自分の権限範囲内のデータのみにアクセス可能となり、機密性が大幅に向上しました。

**修正前の問題**:
- 他社従業員情報の閲覧可能
- 他社活動履歴の閲覧可能
- 認証なしでのシステム情報アクセス

**修正後の状態**:
- 完全な会社間データ分離
- 適切なロールベースアクセス制御
- 最小権限の原則に基づいた認可

これらの修正により、システムのセキュリティレベルが大幅に向上し、企業間のデータ漏洩リスクが排除されました。
